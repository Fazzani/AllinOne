from freebox import plugin
from freebox import common
import xbmc

@plugin.route("/")
def listTorrent():
    authorize()
    listTorrents = requestFreebox(FREEBOX_API + "/downloads")
    plugin.log.info(listTorrents)
    for torrent in ListTorrent:
       yield{
            "label": torrent["name"],
            "thumbnail": torrent["image"],
            "path": plugin.url_for(torrent["view"])
           }

def authorize():
    params = {"app_id": APP_ID,
              "app_name": "freeboxtorrent",
              "app_version": "0.0.1",
              "device_name": "XBMC"}

    auth = url_get(FREEBOX_API + "/login/authorize/", params = params, method='POST')
    if auth['success']:
        plugin.log.info('auth success')
        authStorage = get_storage(name='authStorage', file_format='json', TTL=None)
        #app_token
        authStorage['app_token'] = auth['result']['app_token'] 
        while 1 == 1:
            res = url_get(FREEBOX_API + "/login/authorize/%s" % auth['result']['track_id'])
            if res['result']['status'] == 'granted':
                authStorage['challenge'] = res['result']['challenge']
                authStorage['password'] = getPassword(authStorage['app_token'], authStorage['challenge'])
                authStorage['session'] = getSession(APP_ID, authStorage['password'])
                authStorage.sync()
                break
            xbmc.sleep(1000)
    else:
        plugin.log.info('auth failed')

def getSession(app_id,password):
    #POST /api/v3/login/session/
    res = url_get(FREEBOX_API + "/login/session/",params={ "app_id": app_id, "password": password}, method = "POST")
    if res["success"]:
        return res["result"]
    raise Exception('Getting token session failed')

def getPassword(app_token,challenge):
    from hashlib import sha1
    import hmac

    hashed = hmac.new(app_token, challenge, sha1)
    # The signature
    return hashed.digest().encode("base64").rstrip('\n')

def requestFreebox(path, params={}, method="GET"):
    authStorage = get_storage(name='authStorage', file_format='json', TTL=None)
    HEADERS["X-Fbx-App-Auth"] = authStorage['session']['session_token']
    return url_get(FREEBOX_API + "/login/session/", params, HEADERS, method)

